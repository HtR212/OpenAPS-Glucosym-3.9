#!/bin/bash

while(true); do
    mkdir -p differ
    rsync -tuv --min-size=2 monitor/*.json differ/ 2>/dev/null >/dev/null
    rsync -tuv --min-size=2 settings/*.json differ/ 2>/dev/null >/dev/null
    for branch in $@; do 
        out_file="./$branch.log"
        cd ~/src/oref0 && git checkout $branch 2>/dev/null >/dev/null
        cd - > /dev/null
        oref0-calculate-iob differ/pumphistory-merged.json differ/profile.json differ/clock-zoned.json > differ/iob.json 2>> $out_file
        oref0-meal differ/pumphistory-merged.json settings/profile.json differ/clock-zoned.json differ/glucose.json settings/basal_profile.json differ/carbhistory.json > differ/meal.json 2>> $out_file
        ( oref0-determine-basal differ/iob.json differ/temp_basal.json differ/glucose.json differ/profile.json differ/autosens.json differ/meal.json --microbolus | jq '{rate,duration,reason}' ) 2>>$out_file >> $out_file
        date
    done
    sleep 120
done
